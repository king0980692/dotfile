# bind -n MouseDown1StatusLeft display-message "你點擊了 Session: #S"
bind -n MouseDown1StatusLeft display-popup  -b heavy -x L -y S -T "Session Switcher" -w 20% -h 25% -E "~/.config/leon_scripts/tmux_session_switcher.sh"
bind -n MouseDown3Pane send-keys -M
bind -n MouseDown3Status send-keys -M

#平時隱藏，進入copy mode 自動顯示 border
set -g pane-scrollbars off # modal on
set -g pane-scrollbars-style fg=magenta,bg=default
set-hook -g pane-mode-changed 'if -F "#{pane_in_mode}" "set -p pane-active-border-style fg=magenta" "set -p pane-active-border-style fg=color136,bold"'
set -g mode-style "fg=white,bg=magenta"
# 1. 修改按 `[` 進入模式時，隱藏右上角資訊 (-H)
# bind [ copy-mode -H

# 2. 修改按 `PageUp` 進入模式時，也隱藏 (-u 是向上捲動)
# bind PPage copy-mode -u -H

# (選用) 如果您習慣用滑鼠滾輪進入，需要這行比較複雜的設定：
# 意思：如果 App (如 vim) 不需要滑鼠，就進入 Copy Mode 並隱藏資訊 (-H)
# bind -n WheelUpPane if-shell -F "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e -H'"


unbind C-b
set -g prefix M-q 
# set -g default-terminal "screen-256color"
# set -ga terminal-overrides ',xterm-256color:Tc'
set -s set-clipboard on

unbind-key -T copy-mode-vi MouseDragEnd1Pane
# bind-key -T copy-mode-vi MouseDown1Pane select-pane \; send-keys -X clear-selection
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel

# https://www.reddit.com/r/neovim/comments/1pavsrm/neovim_copy_osc_52_over_ssh_it_took_me_a_hour_to/
set -as terminal-overrides ',*:Ms=\E]52;%p1%s;%p2%s\007'
# set -g default-terminal "xterm-256color"
# set -ga terminal-overrides ",-256color:Tc"

bind R source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded..."

set -g mouse on
set -g focus-events on
set -g status-interval 3


set -gq allow-passthrough on
set -g visual-activity off
set -g base-index 1
set -g renumber-windows on
set -sg escape-time 0


SHORT_PATH_SCRIPT="$HOME/.config/leon_scripts/tmux_pane_status.sh"

###############
# pane-border #
###############

set -g pane-border-status bottom # bottom or off or top
# set -g pane-border-format " [#{pane_current_path}]> "
set -g pane-border-format "#(~/.config/tmux/format_path.sh '#{pane_current_path}' '#{pane_title}' '#{pane_active}')#(~/.config/tmux/cur_cmd.sh '#{pane_tty}' '#{pane_title}' '#{pane_current_path}')#[default]"


# set -g pane-active-border-style 'fg=color238,bold'
set -g pane-active-border-style 'fg=color136,bold'
set -g pane-border-style 'fg=color244'
# set -g pane-border-lines heavy
set -g pane-border-lines heavy




##############
# status bar #
##############

set -g status-position bottom


# set -g status-bg colour234
# set -g status-fg colour137

set -g status-style "bg=default"
set -g window-status-current-style "fg=blue bold"

# set -g status-right '#[fg=colour233,bg=colour241,bold] %d/%m #[fg=colour233,bg=colour245,bold] %H:%M:%S '
# set -g status-left '#S'
set -g status-left '#[fg=color229,bg=color9,bold]  #S #[default] '
# set -g status-right-length 50
set -g status-right ''
set -g status-left-length 30
set -g status-right-length 30

set -g status-justify centre
setw -g window-status-current-format '#I#[fg=colour250]:#[fg=colour255]#W#[fg=colour50]#F'
setw -g window-status-format '#I#[fg=colour237]:#[fg=colour250]#W#[fg=colour244]#F'


# colors
set-option -g status-bg color233
set-option -g status-fg color249
set -g mode-style "fg=color0,bg=color11"




########
# hook #
########

set-hook -g after-new-session 'if-shell "[ \"#{session_name}\" = \"popup\" ]" "set status off; set pane-border-status off"'
set-hook -g after-new-window 'if-shell "[ \"#{session_name}\" = \"popup\" ]" "set status off; set pane-border-status off"'

set-hook -g session-close 'run-shell "if [ \"#{session_name}\" = \"popup\" ]; then tmux detach-client; tmux kill-session -t popup; fi"'
# set-hook -g session-created 'run-shell "~/.config/script/tmux_create_sess.sh"'

# Force refresh pane border on focus change (fixes highlight delay from cached #() output)
# set-hook -g pane-focus-in 'refresh-client -S'


###############
# Pop up asso #
###############
# bind -n MouseDown1Border display-message -t = "點擊位置: X=#{mouse_x}, Y=#{mouse_y}"
# bind -n MouseDown1Border display-message "X=#{mouse_x} Y=#{mouse_y}"

# bind-key -n C-d \
#     run-shell " \
#     if [ '#{session_name}' = 'popup' ] && [ $(tmux list-panes -t #{session_name} | wc -l) -eq 1 ] && [ $(tmux list-windows -t #{session_name} | wc -l) -eq 1 ]; then \
#         if [ -n '#{pane_current_command}' ] && [ '#{pane_current_command}' != 'tmux' ]; then \
#             tmux send-keys C-d; \
#         else \
#             tmux detach-client; \
#             tmux kill-session -t popup; \
#         fi; \
#     else \
#         if [ -n '#{pane_current_command}' ] && [ '#{pane_current_command}' != 'tmux' ]; then \
#             tmux send-keys C-d; \
#         else \
#             tmux kill-pane; \
#         fi; \
#     fi"

bind-key -n C-d if-shell -F '#{==:#{session_name},popup}' {
    if-shell -F '#{==:#{window_panes},1}' {
        if-shell -F '#{==:#{session_windows},1}' {
            if-shell -F '#{!=:#{pane_current_command},tmux}' {
                send-keys C-d
            } {
                detach-client
                kill-session -t popup
            }
        } {
            if-shell -F '#{!=:#{pane_current_command},tmux}' {
                send-keys C-d
            } {
                kill-pane
            }
        }
    } {
        if-shell -F '#{!=:#{pane_current_command},tmux}' {
            send-keys C-d
        } {
            kill-pane
        }
    }
} {
    if-shell -F '#{!=:#{pane_current_command},tmux}' {
        send-keys C-d
    } {
        kill-pane
    }
}
 
set-option -g detach-on-destroy off


bind-key -n -N 'Toggle popup window' M-p if-shell -F '#{==:#{session_name},popup}' {
    detach-client
} {
    display-popup -T "[Pop-Up]" -d "#{pane_current_path}" -xC -yC -w 80% -h 75% -E 'tmux attach-session -t popup || tmux new-session -s popup'
}

###############
# Key Binding #
###############


# -------
#  Basic
# -------

# vim mode yay
setw -g mode-keys vi
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

bind-key -n 'M-h' select-pane -L
bind-key -n 'M-l' select-pane -R
bind-key -n 'M-j' select-pane -D
bind-key -n 'M-k' select-pane -U

# Pane resizing
bind -r Left  resize-pane -L 2
bind -r Down  resize-pane -D 2
bind -r Up    resize-pane -U 2
bind -r Right resize-pane -R 2

bind -n M-Left resize-pane -L 1
bind -n M-Right resize-pane -R 1
bind -n M-Up resize-pane -U 1
bind -n M-Down resize-pane -D 1


# Use vim-style copy mode
bind-key -T copy-mode-vi 'v' send -X begin-selection
# bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel
bind-key -T copy-mode-vi 'y' send -X copy-selection


bind-key x kill-pane # skip "kill-pane 1? (y/n)" prompt

bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window      -c "#{pane_current_path}"

# 移動視窗後，焦點能跟隨著該視窗移動到新的位置
bind-key "<" swap-window -t -1 \; select-window -t -1
bind-key ">" swap-window -t +1 \; select-window -t +1



# ------------
#  no prefix
# ------------


bind-key -n 'M-n' split-window -h -c "#{pane_current_path}" \; select-layout main-vertical
bind-key -n M-\' split-window -c "#{pane_current_path}"
bind-key -n M-5 split-window -h -c "#{pane_current_path}"


# Switch session
# bind -n M-s display-popup -b heavy -T "Session Live Switcher" -w 20% -h 55% -E "~/.config/leon_scripts/tmux_session_switcher.sh"

# 右下角
# bind -n M-s display-popup -s "bg=color255" -S "fg=colour136,bg=colour255" -b heavy -x R -y S  -T "Session Switcher" -w 20% -h 25% -E "~/.config/leon_scripts/tmux_session_switcher.sh"
bind -n M-s display-popup  -b heavy -x L -y S  -T "Session Switcher" -w 20% -h 25% -E "~/.config/leon_scripts/tmux_session_switcher.sh"

# 右上角
# bind -n M-s display-popup -x R -y 0 -b double -T "Session Live Switcher" -w 20% -h 25% -E "~/.config/leon_scripts/tmux_session_switcher.sh"




#########################################
#####    For tmux-vim-navigator     #####
#########################################
bind-key -n 'M-h' select-pane -L
bind-key -n 'M-l' select-pane -R
bind-key -n 'M-j' select-pane -D
bind-key -n 'M-k' select-pane -U

is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

bind-key -n 'M-h' if-shell "$is_vim" 'send-keys M-h'  'select-pane -L'
bind-key -n 'M-j' if-shell "$is_vim" 'send-keys M-j'  'select-pane -D'
bind-key -n 'M-k' if-shell "$is_vim" 'send-keys M-k'  'select-pane -U'
bind-key -n 'M-l' if-shell "$is_vim" 'send-keys M-l'  'select-pane -R'

# tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
# if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
#     "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
# if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
#     "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"

# bind-key -T copy-mode-vi 'C-h' select-pane -L
# bind-key -T copy-mode-vi 'C-j' select-pane -D
# bind-key -T copy-mode-vi 'C-k' select-pane -U
# bind-key -T copy-mode-vi 'C-l' select-pane -R
# bind-key -T copy-mode-vi 'C-\' select-pane -l
#############################################
#####    End For tmux-vim-navigator     #####
#############################################


#################
#      TPM      # 
#################

# TMUX_FZF_OPTIONS="-p -w 32% -h 38% -m --reverse --disabled"
# tmux-fzf 配置（必須在插件加載之前）
set-environment -g TMUX_FZF_LAUNCH_KEY "F"
set-environment -g TMUX_FZF_MENU_POPUP "--bind='change:clear-query'"
set-environment -g TMUX_FZF_OPTIONS "--padding 1,2,2,5 --pointer="➤" --color bg:-1,bg+:-1,gutter:#000000,marker:-1,hl:-1,hl+:-1 --no-input  --cycle --prompt="" --reverse --disabled -p -w 22% -h 29% -x L -y S"
   \
   
# List of plugins
# set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-continuum'
#set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'king0980692/tmux-fzf'
# set -g @plugin 'azorng/tmux-smooth-scroll'
set -g @plugin 'tmux-plugins/tpm'

if "test ! -d $HOME/.config/tmux/plugins/tpm/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm/ && ~/.config/tmux/plugins/tpm/bin/install_plugins'"


# init tmux proj. manager

run "$HOME/.config/tmux/plugins/tpm/tpm" # always at end of file



